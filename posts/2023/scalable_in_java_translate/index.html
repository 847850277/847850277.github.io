<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Scalable in java 翻译 | ZhengPengDe Blog</title>
<meta name="keywords" content="">
<meta name="description" content="目录 Scalable network services 可扩展的网络服务 Event-driven processing 事件驱动处理 Reactor pattern Reactor 模式 Basic version 基本版本 Multithreaded versions 多线程版本 Other variants 其他变体 Walkthrough of java.nio nonblocking IO APIs 预编排java.nio nonblocking IO APIs Network Services 网络服务 Web services, Distributed Objects, etc 网络服务,分布式对象，等等。 Most have same basic structure: 大多数都有以下的基本结构 Read request 读请求 Decode request 解码请求 Process service 处理服务 Encode reply 编码响应 Send reply 发送响应 But differ in nature and cost of each step 当然在实际应用中每一步的运行效率都是不同的，例如其中可能涉及到xml解析、文件传输、web页面的加载、计算服务等不同功能 XML parsing, File transfer, Web page generation, computational services, &hellip; Classic Service Designs 传统的服务设计 Each handler may be started in its own thread 在一般的网络服务当中都会为每一个连接的处理开启一个新的线程，我们可以看下大致的示意图： public class Test { private static Integer PORT = 8080; public static void main(String[] args) { Server server = new Server(); server.">
<meta name="author" content="zhengpengde">
<link rel="canonical" href="https://847850277.github.io/posts/2023/scalable_in_java_translate/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css" integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U&#43;6hYRq/Ez/nm5vg=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://847850277.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://847850277.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://847850277.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://847850277.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://847850277.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Scalable in java 翻译" />
<meta property="og:description" content="目录 Scalable network services 可扩展的网络服务 Event-driven processing 事件驱动处理 Reactor pattern Reactor 模式 Basic version 基本版本 Multithreaded versions 多线程版本 Other variants 其他变体 Walkthrough of java.nio nonblocking IO APIs 预编排java.nio nonblocking IO APIs Network Services 网络服务 Web services, Distributed Objects, etc 网络服务,分布式对象，等等。 Most have same basic structure: 大多数都有以下的基本结构 Read request 读请求 Decode request 解码请求 Process service 处理服务 Encode reply 编码响应 Send reply 发送响应 But differ in nature and cost of each step 当然在实际应用中每一步的运行效率都是不同的，例如其中可能涉及到xml解析、文件传输、web页面的加载、计算服务等不同功能 XML parsing, File transfer, Web page generation, computational services, &hellip; Classic Service Designs 传统的服务设计 Each handler may be started in its own thread 在一般的网络服务当中都会为每一个连接的处理开启一个新的线程，我们可以看下大致的示意图： public class Test { private static Integer PORT = 8080; public static void main(String[] args) { Server server = new Server(); server." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://847850277.github.io/posts/2023/scalable_in_java_translate/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-16T09:27:36+08:00" />
<meta property="article:modified_time" content="2023-08-16T09:27:36+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Scalable in java 翻译"/>
<meta name="twitter:description" content="目录 Scalable network services 可扩展的网络服务 Event-driven processing 事件驱动处理 Reactor pattern Reactor 模式 Basic version 基本版本 Multithreaded versions 多线程版本 Other variants 其他变体 Walkthrough of java.nio nonblocking IO APIs 预编排java.nio nonblocking IO APIs Network Services 网络服务 Web services, Distributed Objects, etc 网络服务,分布式对象，等等。 Most have same basic structure: 大多数都有以下的基本结构 Read request 读请求 Decode request 解码请求 Process service 处理服务 Encode reply 编码响应 Send reply 发送响应 But differ in nature and cost of each step 当然在实际应用中每一步的运行效率都是不同的，例如其中可能涉及到xml解析、文件传输、web页面的加载、计算服务等不同功能 XML parsing, File transfer, Web page generation, computational services, &hellip; Classic Service Designs 传统的服务设计 Each handler may be started in its own thread 在一般的网络服务当中都会为每一个连接的处理开启一个新的线程，我们可以看下大致的示意图： public class Test { private static Integer PORT = 8080; public static void main(String[] args) { Server server = new Server(); server."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://847850277.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Scalable in java 翻译",
      "item": "https://847850277.github.io/posts/2023/scalable_in_java_translate/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Scalable in java 翻译",
  "name": "Scalable in java 翻译",
  "description": "目录 Scalable network services 可扩展的网络服务 Event-driven processing 事件驱动处理 Reactor pattern Reactor 模式 Basic version 基本版本 Multithreaded versions 多线程版本 Other variants 其他变体 Walkthrough of java.nio nonblocking IO APIs 预编排java.nio nonblocking IO APIs Network Services 网络服务 Web services, Distributed Objects, etc 网络服务,分布式对象，等等。 Most have same basic structure: 大多数都有以下的基本结构 Read request 读请求 Decode request 解码请求 Process service 处理服务 Encode reply 编码响应 Send reply 发送响应 But differ in nature and cost of each step 当然在实际应用中每一步的运行效率都是不同的，例如其中可能涉及到xml解析、文件传输、web页面的加载、计算服务等不同功能 XML parsing, File transfer, Web page generation, computational services, \u0026hellip; Classic Service Designs 传统的服务设计 Each handler may be started in its own thread 在一般的网络服务当中都会为每一个连接的处理开启一个新的线程，我们可以看下大致的示意图： public class Test { private static Integer PORT = 8080; public static void main(String[] args) { Server server = new Server(); server.",
  "keywords": [
    
  ],
  "articleBody": "目录 Scalable network services 可扩展的网络服务 Event-driven processing 事件驱动处理 Reactor pattern Reactor 模式 Basic version 基本版本 Multithreaded versions 多线程版本 Other variants 其他变体 Walkthrough of java.nio nonblocking IO APIs 预编排java.nio nonblocking IO APIs Network Services 网络服务 Web services, Distributed Objects, etc 网络服务,分布式对象，等等。 Most have same basic structure: 大多数都有以下的基本结构 Read request 读请求 Decode request 解码请求 Process service 处理服务 Encode reply 编码响应 Send reply 发送响应 But differ in nature and cost of each step 当然在实际应用中每一步的运行效率都是不同的，例如其中可能涉及到xml解析、文件传输、web页面的加载、计算服务等不同功能 XML parsing, File transfer, Web page generation, computational services, … Classic Service Designs 传统的服务设计 Each handler may be started in its own thread 在一般的网络服务当中都会为每一个连接的处理开启一个新的线程，我们可以看下大致的示意图： public class Test { private static Integer PORT = 8080; public static void main(String[] args) { Server server = new Server(); server.run(); } public static class Server implements Runnable { @Override public void run() { try { ServerSocket ss = new ServerSocket(PORT); while (!Thread.interrupted()) { new Thread(new Handler(ss.accept())).start(); } } catch (IOException ex) { } } } public static class Handler implements Runnable { final Socket socket; public Integer MAX_INPUT = 1024; Handler(Socket s) { socket = s; } @Override public void run() { try { byte[] input = new byte[MAX_INPUT]; socket.getInputStream().read(input); byte[] output = process(input); socket.getOutputStream().write(output); } catch (IOException ex) { /* ... */ } } private byte[] process(byte[] cmd) { System.out.println(cmd); return cmd; } } } Classic ServerSocket Loop 构建高性能可伸缩的IO服务 Scalability Goals 在构建高性能可伸缩的IO服务过程中，我们希望达到以下的目标 Graceful degradation under increasing load (more clients) 在海量的负载连接情况下优雅降级 Continuous improvement with increasing resources (CPU, memory, disk, bandwidth) 能随着硬件资源的增加，性能持续改进 Also meet availability and performance goals 还要满足可用性和性能目标 Short latencies 低延时 Meeting peak demand 高吞吐量 Tunable quality of service 可调节服务质量 Divide and Conquer 分治法 Divide-and-conquer is usually the best approach for achieving any scalability goal 分而治之通常是实现任何可伸缩性目标的最佳方法 Divide processing into small tasks 将处理过程分成小任务 Each task performs an action without blocking 每个任务执行一个操作而不阻塞 Execute each task when it is enabled 在启用时执行每个任务 Here, an IO event usually serves as trigger 在这里IO通常用作触发器 Basic mechanisms supported in java.nio java.nio包就很好的实现了上述的机制 Non-blocking reads and writes 非阻塞读和写 Dispatch tasks associated with sensed IO events 调度与感知到的IO事件相关的任务 Endless variation possible 无限变化的可能 A family of event-driven designs 所以结合一系列基于事件驱动模式的设计，给高性能IO服务的架构与设计带来丰富的可扩展性 Event-driven Designs 基于事件驱动模式的设计 Usually more efficient than alternatives 基于事件驱动的架构设计通常比其他架构模型更加有效\nFewer resources 更节约资源 Don’t usually need a thread per client 通常不需要针对每个客户端去启动一个线程 Less overhead 减少线程开销 Less context switching, often less locking 更少的上下文切换和更少的互斥锁 But dispatching can be slower 但是调度可能会更慢 Must manually bind actions to events 必须手动将动作绑定到事件 Usually harder to program 编码的难度更高\nMust break up into simple non-blocking actions 相关功能必须分解成简单的非阻塞操作 Similar to GUI event-driven actions 类似与GUI的事件驱动机制 Cannot eliminate all blocking: GC, page faults, etc 当然也不可能把所有阻塞都消除掉，特别是GC， page faults(内存缺页中断)等 Must keep track of logical state of service 由于是基于事件驱动的，所以需要跟踪服务的相关状态（因为你需要知道什么时候事件会发生） Background: Events in AWT 背景：AWT中事件驱动设计 Event-driven IO uses similar ideas but in different designs 下图是AWT中事件驱动设计的一个简单示意图，可以看到，在不同的架构设计中的基于事件驱动的IO操作使用的基本思路是一致的； Reactor Pattern Reactor模式 Reactor responds to IO events by dispatching the appropriate handler Reactor模式中会通过分配适当的handler(处理程序)来响应IO事件\nSimilar to AWT thread 类似与AWT 事件处理线程 Handlers perform non-blocking actions 每个handler执行非阻塞的操作\nSimilar to AWT ActionListeners 类似于AWT ActionListeners 事件监听 Manage by binding handlers to events 通过将handler绑定到事件进行管理\nSimilar to AWT addActionListener 类似与AWT addActionListener 添加事件监听 See Schmidt et al, Pattern-Oriented Software Architecture, Volume 2 (POSA2) 参见Schmidt et al，面向模式的软件体系结构，第2卷(POSA2)\nAlso Richard Stevens’s networking books, Matt Welsh’s SEDA framework, etc 还有Richard Stevens的网络书籍，Matt Welsh的SEDA框架，等等 Basic Reactor Design 单线程模式 java.nio Support java.nio的一些概念 Channels Connections to files, sockets etc that support non-blocking reads 支持非阻塞读写的socket连接 Buffers Array-like objects that can be directly read or written by Channels 用于被Channels读写的字节数组对象 Selectors Tell which of a set of Channels have IO events 用于判断channle发生IO事件的选择器 SelectionKeys Maintain IO event status and bindings 负责IO事件的状态与绑定 接下来我们一步步看下基于Reactor模式的服务端设计代码示例\nReactor 1: Setup 第一步 Rector线程的初始化\nReactor 2: Dispatch Loop 第二步 分发调度\nReactor 3: Acceptor 第二步 分发调度 接收器\nReactor 4: Handler setup 第四步 Handler初始化\nReactor 5: Request handling 第五步 请求处理\nPer-State Handlers 基于GoF状态对象模式对Handler类的一个优化实现，不需要再进行状态的判断\nimport java.io.IOException; import java.net.InetSocketAddress; import java.nio.channels.SelectionKey; import java.nio.channels.Selector; import java.nio.channels.ServerSocketChannel; import java.nio.channels.SocketChannel; import java.util.Iterator; import java.util.Set; public class Reactor implements Runnable{ public static void main(String[] args) { try { new Reactor(8080).run(); } catch (IOException e) { throw new RuntimeException(e); } } final Selector selector; final ServerSocketChannel serverSocket; Reactor(int port) throws IOException { selector = Selector.open(); serverSocket = ServerSocketChannel.open(); serverSocket.socket().bind(new InetSocketAddress(port)); serverSocket.configureBlocking(false); SelectionKey sk = serverSocket.register(selector, SelectionKey.OP_ACCEPT); //注册accept事件 sk.attach(new Acceptor()); //调用Acceptor()为回调方法 } public void run() { try { while (!Thread.interrupted()) {//循环 selector.select(); Set selected = selector.selectedKeys(); Iterator it = selected.iterator(); while (it.hasNext()){ //dispatch分发事件 dispatch((SelectionKey)it.next()); } selected.clear(); } } catch (IOException ex) { /* ... */ } } void dispatch(SelectionKey k) { Runnable r = (Runnable)(k.attachment()); //调用SelectionKey绑定的调用对象 if (r != null) r.run(); } // Acceptor 连接处理类 class Acceptor implements Runnable { // inner public void run() { try { SocketChannel c = serverSocket.accept(); if (c != null) new Handler(selector, c); } catch(IOException ex) { /* ... */ } } } } import java.io.IOException; import java.nio.ByteBuffer; import java.nio.channels.SelectionKey; import java.nio.channels.Selector; import java.nio.channels.SocketChannel; public class Handler implements Runnable{ final SocketChannel socket; final SelectionKey sk; ByteBuffer input = ByteBuffer.allocate(1024); ByteBuffer output = ByteBuffer.allocate(1024); static final int READING = 0, SENDING = 1; int state = READING; Handler(Selector sel, SocketChannel c) throws IOException { socket = c; c.configureBlocking(false); // Optionally try first read now sk = socket.register(sel, 0); sk.attach(this); //将Handler绑定到SelectionKey上 sk.interestOps(SelectionKey.OP_READ); sel.wakeup(); } boolean inputIsComplete() { /* ... */ return false; } boolean outputIsComplete() { /* ... */ return false; } void process() { /* ... */ } /** * 这是Handler处理类 */ /**/ @Override public void run() { try { if (state == READING) read(); else if (state == SENDING) send(); } catch (IOException ex) { } } void read() throws IOException { socket.read(input); if (inputIsComplete()) { process(); state = SENDING; // Normally also do first write now sk.interestOps(SelectionKey.OP_WRITE); } } void send() throws IOException { socket.write(output); if (outputIsComplete()) sk.cancel(); } /** * 下面是基于GoF状态对象模式对Handler类的一个优化实现，不需要再进行状态的判断。 */ /* @Override public void run() { // initial state is reader try { socket.read(input); } catch (IOException e) { throw new RuntimeException(e); } if (inputIsComplete()) { process(); sk.attach(new Sender()); sk.interestOps(SelectionKey.OP_WRITE); sk.selector().wakeup(); } } class Sender implements Runnable { public void run(){ // ... try { socket.write(output); } catch (IOException e) { throw new RuntimeException(e); } if (outputIsComplete()) sk.cancel(); } } */ } Multithreaded Designs 多线程设计 Strategically add threads for scalability 策略性地添加线程以提高可伸缩性 Mainly applicable to multiprocessors 主要适用于多处理器 Worker Threads 增加工作线程 专门处理非IO操作 Reactors should quickly trigger handlers 反应器线程需要迅速触发处理流程 Handler processing slows down Reactor 如果处理过程也就是process()方法产生阻塞会拖慢反应器线程的性能 Offload non-IO processing to other threads 我们需要把一些非IO操作交给Woker线程来做 Multiple Reactor Threads 拆分并增加反应器Reactor线程 Reactor threads can saturate doing IO 在压力较大时可以饱和处理IO操作，提高处理能力 Distribute load to other reactors 维持多个Reactor线程也可以做负载均衡使用 Load-balance to match CPU and IO rates 线程的数量可以根据程序本身是CPU密集型还是IO密集型操作来进行合理的分配 Worker Threads 工作线程 Offload non-IO processing to speed up Reactor thread 通过卸载非IO操作来提升Reactor 线程的处理性能 Similar to POSA2 Proactor designs 类似与POSA2 中Proactor的设计 Simpler than reworking compute-bound processing into event-driven form 比将非IO操作重新设计为事件驱动的方式更简单 Should still be pure nonblocking computation 仍然应该是纯粹的非阻塞计算 Enough processing to outweigh overhead 足够的处理超过开销 But harder to overlap processing with IO 但是很难将处理与IO重叠 Best when can first read all input into a buffer 最好能在第一时间将所有输入读入缓冲区 （这里我理解的是最好一次性读取缓冲区数据，方便异步非IO操作处理数据） Use thread pool so can tune and control 可以通过线程池的方式对线程进行调优与控制 Normally need many fewer threads than clients 通常需要比客户端少得多的线程 Handler with Thread Pool 带有线程池的处理器 import java.io.IOException; import java.nio.ByteBuffer; import java.nio.channels.SelectionKey; import java.nio.channels.Selector; import java.nio.channels.SocketChannel; import java.util.concurrent.ArrayBlockingQueue; import java.util.concurrent.ThreadPoolExecutor; import java.util.concurrent.TimeUnit; public class Handler implements Runnable{ private static final int CORE_POOL_SIZE = 5; private static final int MAX_POOL_SIZE = 10; private static final int QUEUE_CAPACITY = 100; private static final Long KEEP_ALIVE_TIME = 1L; // uses util.concurrent thread pool static ThreadPoolExecutor pool = new ThreadPoolExecutor( CORE_POOL_SIZE, MAX_POOL_SIZE, KEEP_ALIVE_TIME, TimeUnit.SECONDS, new ArrayBlockingQueue\u003c\u003e(QUEUE_CAPACITY), new ThreadPoolExecutor.CallerRunsPolicy()); static final int PROCESSING = 3; final SocketChannel socket; final SelectionKey sk; ByteBuffer input = ByteBuffer.allocate(1024); ByteBuffer output = ByteBuffer.allocate(1024); static final int READING = 0, SENDING = 1; int state = READING; Handler(Selector sel, SocketChannel c) throws IOException { socket = c; c.configureBlocking(false); // Optionally try first read now sk = socket.register(sel, 0); sk.attach(this); //将Handler绑定到SelectionKey上 sk.interestOps(SelectionKey.OP_READ); sel.wakeup(); } boolean inputIsComplete() { /* ... */ return false; } boolean outputIsComplete() { /* ... */ return false; } void process() { /* ... */ } /** * 这是Handler处理类 */ /**/ @Override public void run() { try { if (state == READING) read(); else if (state == SENDING) send(); } catch (IOException ex) { } } synchronized void read() throws IOException { socket.read(input); if (inputIsComplete()) { // process(); // state = SENDING; // // Normally also do first write now // sk.interestOps(SelectionKey.OP_WRITE); state = PROCESSING; pool.execute(new Processer()); } } void send() throws IOException { socket.write(output); if (outputIsComplete()) sk.cancel(); } synchronized void processAndHandOff() { process(); state = SENDING; // or rebind attachment sk.interestOps(SelectionKey.OP_WRITE); } class Processer implements Runnable { public void run() { processAndHandOff(); } } } Coordinating Tasks 协调任务 当你把非IO操作放到线程池中运行时，你需要注意以下几点问题\nHandoffs 交接 Each task enables, triggers, or calls next one Usually fastest but can be brittle 任务之间的协调与控制，每个任务的启动、执行、传递的速度是很快的，不容易协调与控制 Callbacks to per-handler dispatcher 每个hander中dispatch的回调与状态控制 Sets state, attachment, etc A variant of GoF Mediator pattern 设置状态、附件等。GoF中介模式的一种变体 Queues 不同线程之间缓冲区的线程安全问题 For example, passing buffers across stages 例如，跨阶段传递缓冲区 Futures When each task produces a result Coordination layered on top of join or wait/notify 需要任务返回结果时，任务线程等待和唤醒状态间的切换 Using PooledExecutor 可以使用PooledExecutor线程池框架解决上面的问题 A tunable worker thread pool 这是一个可控的任务线程池 Main method execute(Runnable r) 主函数采用execute(Runnable r) Controls for: 它具备以下功能，可以很好的对池中的线程与任务进行控制与管理 The kind of task queue (any Channel) 任务队列的类型(任何通道) Maximum number of threads 最大线程数 Minimum number of threads 最小线程数 “Warm” versus on-demand threads “预热\"以应对随机应变的线程 按需要判断线程的活动状态，及时处理空闲线程 Keep-alive interval until idle threads die 保持活动间隔，直到空闲线程死亡 to be later replaced by new ones if necessary 如有必要，以后再用新的代替 Saturation policy 饱和策略 当执行任务数量超过线程池中线程数量时，有一系列的阻塞、限流的策略 block, drop, producer-runs, etc 阻塞,抛弃,producer-runs等 Multiple Reactor Threads 基于多个反应器的多线程模式 Using Reactor Pools 使用反应器线程池 Use to match CPU and IO rates 一方面根据实际情况用于匹配调节CPU处理与IO读写的效率，提高系统资源的利用率 Static or dynamic construction 另一方面在静态或动态构造中 Each with own Selector, Thread, dispatch loop 每个反应器线程都包含对应的Selector,Thread,dispatchloop Main acceptor distributes to other reactors 下面是一个简单的代码示例与示意图（Netty就是基于这个模式设计的，一个处理Accpet连接的mainReactor线程，多个处理IO事件的subReactor线程） Selector[] selectors; // Selector集合，每一个Selector 对应一个subReactor线程 //mainReactor线程 class Acceptor { // ... public synchronized void run() { //... Socket connection = serverSocket.accept(); if (connection != null) new Handler(selectors[next], connection); if (++next == selectors.length) next = 0; } } Using other java.nio features 在服务的设计当中，我们还需要注意与java.nio包特性的结合 Multiple Selectors per Reactor 每个反应器有多个选择器 To bind different handlers to different IO events May need careful synchronization to coordinate 要将不同的处理程序绑定到不同的IO事件可能需要细致的同步协调编码 File transfer 文件传输 Automated file-to-net or net-to-file copying 自动文件到网络或网络到文件复制 Memory-mapped files 内存映射文件的方式 Access files via buffers 通过缓存区访问文件 Direct buffers 直接缓冲区的方式 Can sometimes achieve zero-copy transfer But have setup and finalization overhead Best for applications with long-lived connections 在合适的情况下可以使用零拷贝传输，但同时这会带来初始化与内存释放的问题（需要池化与主动释放） Connection-Based Extensions 基于连接的扩展 Instead of a single service request 并不是单个服务请求 Client connects 客户端连接 Client sends a series of messages/requests 客户端发送一系列的消息/请求 Client disconnects 客户端断开连接 Examples 样例 Databases and Transaction monitors 数据库和事务监视器 Multi-participant games, chat, etc 多人游戏、聊天等 Can extend basic network service patterns 可以扩展基本的网络服务模式 Handle many relatively long-lived clients 处理许多寿命相对较长的客户机 Track client and session state (including drops) 跟踪客户端和会话状态(包括丢弃) Distribute services across multiple hosts 跨多个主机分发服务 API Walkthrough Buffer ByteBuffer (CharBuffer, LongBuffer, etc not shown.) Channel SelectableChannel SocketChannel ServerSocketChannel FileChannel Selector SelectionKey Buffer\nabstract class Buffer { int capacity(); int position(); Buffer position(int newPosition); int limit(); Buffer limit(int newLimit); Buffer mark(); Buffer reset(); Buffer clear(); Buffer flip(); Buffer rewind(); int remaining(); boolean hasRemaining(); boolean isReadOnly(); } ByteBuffer\nabstract class ByteBuffer extends Buffer { static ByteBuffer allocateDirect(int capacity); static ByteBuffer allocate(int capacity); static ByteBuffer wrap(byte[] src, int offset, int len); static ByteBuffer wrap(byte[] src); boolean isDirect(); ByteOrder order(); ByteBuffer order(ByteOrder bo); ByteBuffer slice(); ByteBuffer duplicate(); ByteBuffer compact(); ByteBuffer asReadOnlyBuffer(); byte get(); byte get(int index); ByteBuffer get(byte[] dst, int offset, int length); ByteBuffer get(byte[] dst); ByteBuffer put(byte b); ByteBuffer put(int index, byte b); ByteBuffer put(byte[] src, int offset, int length); ByteBuffer put(ByteBuffer src); ByteBuffer put(byte[] src); char getChar(); char getChar(int index); ByteBuffer putChar(char value); ByteBuffer putChar(int index, char value); CharBuffer asCharBuffer(); short getShort(); short getShort(int index); ByteBuffer putShort(short value); ByteBuffer putShort(int index, short value); ShortBuffer asShortBuffer(); int getInt(); int getInt(int index); ByteBuffer putInt(int value); ByteBuffer putInt(int index, int value); IntBuffer asIntBuffer(); long getLong(); long getLong(int index); ByteBuffer putLong(long value); ByteBuffer putLong(int index, long value); LongBuffer asLongBuffer(); float getFloat(); float getFloat(int index); ByteBuffer putFloat(float value); ByteBuffer putFloat(int index, float value); FloatBuffer asFloatBuffer(); double getDouble(); double getDouble(int index); ByteBuffer putDouble(double value); ByteBuffer putDouble(int index, double value); DoubleBuffer asDoubleBuffer(); } Channel\ninterface Channel { boolean isOpen(); void close() throws IOException; } interface ReadableByteChannel extends Channel { int read(ByteBuffer dst) throws IOException; } interface WritableByteChannel extends Channel { int write(ByteBuffer src) throws IOException; } interface ScatteringByteChannel extends ReadableByteChannel { int read(ByteBuffer[] dsts, int offset, int length) throws IOException; int read(ByteBuffer[] dsts) throws IOException; } interface GatheringByteChannel extends WritableByteChannel { int write(ByteBuffer[] srcs, int offset, int length) throws IOException; int write(ByteBuffer[] srcs) throws IOException; } SelectableChannel\nabstract class SelectableChannel implements Channel { int validOps(); boolean isRegistered(); SelectionKey keyFor(Selector sel); SelectionKey register(Selector sel, int ops) throws ClosedChannelException; void configureBlocking(boolean block) throws IOException; boolean isBlocking(); Object blockingLock(); } SocketChannel\nabstract class SocketChannel implements ByteChannel{ static SocketChannel open() throws IOException; Socket socket(); int validOps(); boolean isConnected(); boolean isConnectionPending(); boolean isInputOpen(); boolean isOutputOpen(); boolean connect(SocketAddress remote) throws IOException; boolean finishConnect() throws IOException; void shutdownInput() throws IOException; void shutdownOutput() throws IOException; int read(ByteBuffer dst) throws IOException; int read(ByteBuffer[] dsts, int offset, int length) throws IOException; int read(ByteBuffer[] dsts) throws IOException; int write(ByteBuffer src) throws IOException; int write(ByteBuffer[] srcs, int offset, int length) throws IOException; int write(ByteBuffer[] srcs) throws IOException; } ServerSocketChannel\nabstract class ServerSocketChannel extends SocketChannel { static ServerSocketChannel open() throws IOException; int validOps(); ServerSocket socket(); SocketChannel accept() throws IOException; } FileChannel\nabstract class FileChannel implements ... { int read(ByteBuffer dst); int read(ByteBuffer dst, long position); int read(ByteBuffer[] dsts, int offset, int length); int read(ByteBuffer[] dsts); int write(ByteBuffer src); int write(ByteBuffer src, long position); int write(ByteBuffer[] srcs, int offset, int length); int write(ByteBuffer[] srcs); long position(); void position(long newPosition); long size(); void truncate(long size); void force(boolean flushMetaDataToo); int transferTo(long position, int count, WritableByteChannel dst); int transferFrom(ReadableByteChannel src, long position, int count); FileLock lock(long position, long size, boolean shared); FileLock lock(); FileLock tryLock(long pos, long size, boolean shared); FileLock tryLock(); static final int MAP_RO, MAP_RW, MAP_COW; MappedByteBuffer map(int mode, long position, int size); } Selector\nabstract class Selector { static Selector open() throws IOException; Set keys(); Set selectedKeys(); int selectNow() throws IOException; int select(long timeout) throws IOException; int select() throws IOException; void wakeup(); void close() throws IOException; } SelectionKey\nabstract class SelectionKey { static final int OP_READ, OP_WRITE, OP_CONNECT, OP_ACCEPT; SelectableChannel channel(); Selector selector(); boolean isValid(); void cancel(); int interestOps(); void interestOps(int ops); int readyOps(); boolean isReadable(); boolean isWritable(); boolean isConnectable(); boolean isAcceptable(); Object attach(Object ob); Object attachment(); } Doug Lea - Scalable IO in Java 《Scalable IO in Java》译文 ",
  "wordCount" : "2304",
  "inLanguage": "en",
  "datePublished": "2023-08-16T09:27:36+08:00",
  "dateModified": "2023-08-16T09:27:36+08:00",
  "author":{
    "@type": "Person",
    "name": "zhengpengde"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://847850277.github.io/posts/2023/scalable_in_java_translate/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ZhengPengDe Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://847850277.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://847850277.github.io/" accesskey="h" title="ZhengPengDe Blog (Alt + H)">ZhengPengDe Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Scalable in java 翻译
    </h1>
    <div class="post-meta"><span title='2023-08-16 09:27:36 +0800 CST'>August 16, 2023</span>&nbsp;·&nbsp;zhengpengde

</div>
  </header> 
  <div class="post-content"><h2 id="目录">目录<a hidden class="anchor" aria-hidden="true" href="#目录">#</a></h2>
<ul>
<li><code>Scalable network services</code> 可扩展的网络服务</li>
<li><code>Event-driven processing</code> 事件驱动处理</li>
<li><code>Reactor pattern</code> Reactor 模式
<ul>
<li><code>Basic version</code> 基本版本</li>
<li><code>Multithreaded versions</code> 多线程版本</li>
<li><code>Other variants</code> 其他变体</li>
</ul>
</li>
<li><code>Walkthrough of java.nio nonblocking IO APIs</code> 预编排<code>java.nio nonblocking IO APIs</code></li>
</ul>
<h2 id="network-services-网络服务">Network Services 网络服务<a hidden class="anchor" aria-hidden="true" href="#network-services-网络服务">#</a></h2>
<ul>
<li>Web services, Distributed Objects, etc 网络服务,分布式对象，等等。</li>
<li>Most have same basic structure: 大多数都有以下的基本结构
<ul>
<li>Read request 读请求</li>
<li>Decode request 解码请求</li>
<li>Process service 处理服务</li>
<li>Encode reply 编码响应</li>
<li>Send reply 发送响应</li>
</ul>
</li>
<li>But differ in nature and cost of each step 当然在实际应用中每一步的运行效率都是不同的，例如其中可能涉及到xml解析、文件传输、web页面的加载、计算服务等不同功能
<ul>
<li>XML parsing, File transfer, Web page generation, computational services, &hellip;</li>
</ul>
</li>
</ul>
<h3 id="classic-service-designs-传统的服务设计">Classic Service Designs 传统的服务设计<a hidden class="anchor" aria-hidden="true" href="#classic-service-designs-传统的服务设计">#</a></h3>
<ul>
<li>Each handler may be started in its own thread  在一般的网络服务当中都会为每一个连接的处理开启一个新的线程，我们可以看下大致的示意图：</li>
</ul>
<p><img loading="lazy" src="/img/source/scalable_in_java/%e5%9b%be%e7%89%87_20230816094711.png" alt="classic"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Test</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Integer PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">8080</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Server server <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Server<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        server<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                ServerSocket ss <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ServerSocket<span style="color:#f92672">(</span>PORT<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupted</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Handler<span style="color:#f92672">(</span>ss<span style="color:#f92672">.</span><span style="color:#a6e22e">accept</span><span style="color:#f92672">())).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Handler</span> <span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> Socket socket<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> Integer MAX_INPUT <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Handler<span style="color:#f92672">(</span>Socket s<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            socket <span style="color:#f92672">=</span> s<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> input <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[</span>MAX_INPUT<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>                socket<span style="color:#f92672">.</span><span style="color:#a6e22e">getInputStream</span><span style="color:#f92672">().</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>input<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> output <span style="color:#f92672">=</span> process<span style="color:#f92672">(</span>input<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                socket<span style="color:#f92672">.</span><span style="color:#a6e22e">getOutputStream</span><span style="color:#f92672">().</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>output<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">/* ... */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> <span style="color:#a6e22e">process</span><span style="color:#f92672">(</span><span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> cmd<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>cmd<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> cmd<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="classic-serversocket-loop-构建高性能可伸缩的io服务">Classic ServerSocket Loop 构建高性能可伸缩的IO服务<a hidden class="anchor" aria-hidden="true" href="#classic-serversocket-loop-构建高性能可伸缩的io服务">#</a></h3>
<ul>
<li>Scalability Goals 在构建高性能可伸缩的IO服务过程中，我们希望达到以下的目标
<ul>
<li>Graceful degradation under increasing load (more clients) 在海量的负载连接情况下优雅降级</li>
<li>Continuous improvement with increasing resources (CPU, memory, disk, bandwidth) 能随着硬件资源的增加，性能持续改进</li>
<li>Also meet availability and performance goals 还要满足可用性和性能目标
<ul>
<li>Short latencies 低延时</li>
<li>Meeting peak demand 高吞吐量</li>
<li>Tunable quality of service 可调节服务质量</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="divide-and-conquer-分治法">Divide and Conquer 分治法<a hidden class="anchor" aria-hidden="true" href="#divide-and-conquer-分治法">#</a></h3>
<ul>
<li>Divide-and-conquer is usually the best approach for achieving any scalability goal 分而治之通常是实现任何可伸缩性目标的最佳方法
<ul>
<li>Divide processing into small tasks 将处理过程分成小任务
<ul>
<li>Each task performs an action without blocking 每个任务执行一个操作而不阻塞</li>
</ul>
</li>
<li>Execute each task when it is enabled 在启用时执行每个任务
<ul>
<li>Here, an IO event usually serves as trigger 在这里IO通常用作触发器 <img loading="lazy" src="/img/source/scalable_in_java/%e5%9b%be%e7%89%87_20230816105320.png" alt="demo"  />
</li>
</ul>
</li>
<li>Basic mechanisms supported in java.nio java.nio包就很好的实现了上述的机制
<ul>
<li><code>Non-blocking</code> reads and writes <code>非阻塞</code>读和写</li>
<li><code>Dispatch</code> tasks associated with sensed IO events <code>调度</code>与感知到的IO事件相关的任务</li>
</ul>
</li>
<li>Endless variation possible 无限变化的可能
<ul>
<li>A family of event-driven designs 所以结合一系列基于事件驱动模式的设计，给高性能IO服务的架构与设计带来丰富的可扩展性</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="event-driven-designs-基于事件驱动模式的设计">Event-driven Designs 基于事件驱动模式的设计<a hidden class="anchor" aria-hidden="true" href="#event-driven-designs-基于事件驱动模式的设计">#</a></h3>
<ul>
<li>
<p>Usually more efficient than alternatives 基于事件驱动的架构设计通常比其他架构模型更加有效</p>
<ul>
<li>Fewer resources 更节约资源
<ul>
<li>Don&rsquo;t usually need a thread per client 通常不需要针对每个客户端去启动一个线程</li>
</ul>
</li>
<li>Less overhead 减少线程开销
<ul>
<li>Less context switching, often less locking 更少的上下文切换和更少的互斥锁</li>
</ul>
</li>
<li>But dispatching can be slower 但是调度可能会更慢
<ul>
<li>Must manually bind actions to events 必须手动将动作绑定到事件</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Usually harder to program 编码的难度更高</p>
<ul>
<li>Must break up into simple non-blocking actions 相关功能必须分解成简单的非阻塞操作
<ul>
<li>Similar to GUI event-driven actions 类似与GUI的事件驱动机制</li>
<li>Cannot eliminate all blocking: GC, page faults, etc 当然也不可能把所有阻塞都消除掉，特别是GC， page faults(内存缺页中断)等</li>
</ul>
</li>
<li>Must keep track of logical state of service 由于是基于事件驱动的，所以需要跟踪服务的相关状态（因为你需要知道什么时候事件会发生）</li>
</ul>
</li>
</ul>
<h4 id="background-events-in-awt-背景awt中事件驱动设计">Background: Events in AWT 背景：AWT中事件驱动设计<a hidden class="anchor" aria-hidden="true" href="#background-events-in-awt-背景awt中事件驱动设计">#</a></h4>
<ul>
<li>Event-driven IO uses similar ideas but in different designs 下图是AWT中事件驱动设计的一个简单示意图，可以看到，在不同的架构设计中的基于事件驱动的IO操作使用的基本思路是一致的；</li>
</ul>
<p><img loading="lazy" src="/img/source/scalable_in_java/%e5%9b%be%e7%89%87_20230816113003.png" alt="图片_20230816113003"  />
</p>
<h3 id="reactor-pattern-reactor模式">Reactor Pattern Reactor模式<a hidden class="anchor" aria-hidden="true" href="#reactor-pattern-reactor模式">#</a></h3>
<ul>
<li>
<p><code>Reactor</code> responds to IO events by dispatching the appropriate handler <code>Reactor</code>模式中会通过分配适当的handler(处理程序)来响应IO事件</p>
<ul>
<li>Similar to AWT thread 类似与AWT 事件处理线程</li>
</ul>
</li>
<li>
<p><code>Handlers</code> perform non-blocking actions 每个handler执行非阻塞的操作</p>
<ul>
<li>Similar to AWT ActionListeners 类似于AWT ActionListeners 事件监听</li>
</ul>
</li>
<li>
<p>Manage by binding handlers to events 通过将handler绑定到事件进行管理</p>
<ul>
<li>Similar to AWT addActionListener 类似与AWT addActionListener 添加事件监听</li>
</ul>
</li>
<li>
<p>See Schmidt et al, Pattern-Oriented Software Architecture, Volume 2 (POSA2) 参见Schmidt et al，面向模式的软件体系结构，第2卷(POSA2)</p>
<ul>
<li>Also Richard Stevens&rsquo;s networking books, Matt Welsh&rsquo;s SEDA framework, etc 还有Richard Stevens的网络书籍，Matt Welsh的SEDA框架，等等</li>
</ul>
</li>
</ul>
<h4 id="basic-reactor-design-单线程模式">Basic Reactor Design 单线程模式<a hidden class="anchor" aria-hidden="true" href="#basic-reactor-design-单线程模式">#</a></h4>
<p><img loading="lazy" src="/img/source/scalable_in_java/%e5%9b%be%e7%89%87_20230816141616.png" alt="图片_20230816141616"  />
</p>
<ul>
<li>java.nio Support <code>java.nio</code>的一些概念</li>
<li>Channels
<ul>
<li>Connections to files, sockets etc that support non-blocking reads 支持非阻塞读写的socket连接</li>
</ul>
</li>
<li>Buffers
<ul>
<li>Array-like objects that can be directly read or written by Channels 用于被Channels读写的字节数组对象</li>
</ul>
</li>
<li>Selectors
<ul>
<li>Tell which of a set of Channels have IO events 用于判断channle发生IO事件的选择器</li>
</ul>
</li>
<li>SelectionKeys
<ul>
<li>Maintain IO event status and bindings 负责IO事件的状态与绑定</li>
</ul>
</li>
</ul>
<p>接下来我们一步步看下基于Reactor模式的服务端设计代码示例</p>
<ul>
<li>
<p>Reactor 1: Setup    第一步 Rector线程的初始化</p>
</li>
<li>
<p>Reactor 2: Dispatch Loop  第二步 分发调度</p>
</li>
<li>
<p>Reactor 3: Acceptor  第二步 分发调度 接收器</p>
</li>
<li>
<p>Reactor 4: Handler setup 第四步 Handler初始化</p>
</li>
<li>
<p>Reactor 5: Request handling 第五步 请求处理</p>
</li>
<li>
<p>Per-State Handlers 基于GoF状态对象模式对Handler类的一个优化实现，不需要再进行状态的判断</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.net.InetSocketAddress<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.channels.SelectionKey<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.channels.Selector<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.channels.ServerSocketChannel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.channels.SocketChannel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Iterator<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Set<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Reactor</span> <span style="color:#66d9ef">implements</span> Runnable<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">new</span> Reactor<span style="color:#f92672">(</span><span style="color:#ae81ff">8080</span><span style="color:#f92672">).</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> Selector selector<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> ServerSocketChannel serverSocket<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  Reactor<span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> port<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    selector <span style="color:#f92672">=</span> Selector<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    serverSocket <span style="color:#f92672">=</span> ServerSocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    serverSocket<span style="color:#f92672">.</span><span style="color:#a6e22e">socket</span><span style="color:#f92672">().</span><span style="color:#a6e22e">bind</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> InetSocketAddress<span style="color:#f92672">(</span>port<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    serverSocket<span style="color:#f92672">.</span><span style="color:#a6e22e">configureBlocking</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    SelectionKey sk <span style="color:#f92672">=</span> serverSocket<span style="color:#f92672">.</span><span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>selector<span style="color:#f92672">,</span> SelectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">OP_ACCEPT</span><span style="color:#f92672">);</span> <span style="color:#75715e">//注册accept事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sk<span style="color:#f92672">.</span><span style="color:#a6e22e">attach</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Acceptor<span style="color:#f92672">());</span> <span style="color:#75715e">//调用Acceptor()为回调方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">while</span> <span style="color:#f92672">(!</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">interrupted</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span><span style="color:#75715e">//循环
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        selector<span style="color:#f92672">.</span><span style="color:#a6e22e">select</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        Set selected <span style="color:#f92672">=</span> selector<span style="color:#f92672">.</span><span style="color:#a6e22e">selectedKeys</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        Iterator it <span style="color:#f92672">=</span> selected<span style="color:#f92672">.</span><span style="color:#a6e22e">iterator</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>it<span style="color:#f92672">.</span><span style="color:#a6e22e">hasNext</span><span style="color:#f92672">()){</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">//dispatch分发事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          dispatch<span style="color:#f92672">((</span>SelectionKey<span style="color:#f92672">)</span>it<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        selected<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">/* ... */</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dispatch</span><span style="color:#f92672">(</span>SelectionKey k<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Runnable r <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Runnable<span style="color:#f92672">)(</span>k<span style="color:#f92672">.</span><span style="color:#a6e22e">attachment</span><span style="color:#f92672">());</span> <span style="color:#75715e">//调用SelectionKey绑定的调用对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      r<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Acceptor 连接处理类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Acceptor</span> <span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span> <span style="color:#75715e">// inner
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        SocketChannel c <span style="color:#f92672">=</span> serverSocket<span style="color:#f92672">.</span><span style="color:#a6e22e">accept</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>c <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">new</span> Handler<span style="color:#f92672">(</span>selector<span style="color:#f92672">,</span> c<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>IOException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">/* ... */</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.ByteBuffer<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.channels.SelectionKey<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.channels.Selector<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.channels.SocketChannel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Handler</span> <span style="color:#66d9ef">implements</span> Runnable<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> SocketChannel socket<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> SelectionKey sk<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    ByteBuffer input <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    ByteBuffer output <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> READING <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> SENDING <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> state <span style="color:#f92672">=</span> READING<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Handler<span style="color:#f92672">(</span>Selector sel<span style="color:#f92672">,</span> SocketChannel c<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        socket <span style="color:#f92672">=</span> c<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        c<span style="color:#f92672">.</span><span style="color:#a6e22e">configureBlocking</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Optionally try first read now
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        sk <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span><span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>sel<span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        sk<span style="color:#f92672">.</span><span style="color:#a6e22e">attach</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span> <span style="color:#75715e">//将Handler绑定到SelectionKey上
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        sk<span style="color:#f92672">.</span><span style="color:#a6e22e">interestOps</span><span style="color:#f92672">(</span>SelectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">OP_READ</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        sel<span style="color:#f92672">.</span><span style="color:#a6e22e">wakeup</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">inputIsComplete</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">/* ... */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">outputIsComplete</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">/* ... */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">process</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">/* ... */</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 这是Handler处理类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>state <span style="color:#f92672">==</span> READING<span style="color:#f92672">)</span> read<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>state <span style="color:#f92672">==</span> SENDING<span style="color:#f92672">)</span> send<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">read</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        socket<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>input<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>inputIsComplete<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            process<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            state <span style="color:#f92672">=</span> SENDING<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Normally also do first write now
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            sk<span style="color:#f92672">.</span><span style="color:#a6e22e">interestOps</span><span style="color:#f92672">(</span>SelectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">OP_WRITE</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">send</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        socket<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>output<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>outputIsComplete<span style="color:#f92672">())</span> sk<span style="color:#f92672">.</span><span style="color:#a6e22e">cancel</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 下面是基于GoF状态对象模式对Handler类的一个优化实现，不需要再进行状态的判断。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    @Override
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    public void run() { // initial state is reader
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        try {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            socket.read(input);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        } catch (IOException e) {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            throw new RuntimeException(e);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        if (inputIsComplete()) {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            process();
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            sk.attach(new Sender());
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            sk.interestOps(SelectionKey.OP_WRITE);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            sk.selector().wakeup();
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    class Sender implements Runnable {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        public void run(){ // ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            try {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                socket.write(output);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            } catch (IOException e) {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                throw new RuntimeException(e);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            if (outputIsComplete()) sk.cancel();
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    }
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="multithreaded-designs-多线程设计">Multithreaded Designs 多线程设计<a hidden class="anchor" aria-hidden="true" href="#multithreaded-designs-多线程设计">#</a></h4>
<ul>
<li>Strategically add threads for scalability 策略性地添加线程以提高可伸缩性
<ul>
<li>Mainly applicable to multiprocessors 主要适用于多处理器</li>
</ul>
</li>
<li>Worker Threads 增加工作线程 专门处理非IO操作
<ul>
<li>Reactors should quickly trigger handlers 反应器线程需要迅速触发处理流程
<ul>
<li>Handler processing slows down Reactor 如果处理过程也就是process()方法产生阻塞会拖慢反应器线程的性能</li>
</ul>
</li>
<li>Offload non-IO processing to other threads 我们需要把一些非IO操作交给Woker线程来做</li>
</ul>
</li>
<li>Multiple Reactor Threads 拆分并增加反应器Reactor线程
<ul>
<li>Reactor threads can saturate doing IO 在压力较大时可以饱和处理IO操作，提高处理能力</li>
<li>Distribute load to other reactors 维持多个Reactor线程也可以做负载均衡使用
<ul>
<li>Load-balance to match CPU and IO rates 线程的数量可以根据程序本身是CPU密集型还是IO密集型操作来进行合理的分配</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="worker-threads-工作线程">Worker Threads 工作线程<a hidden class="anchor" aria-hidden="true" href="#worker-threads-工作线程">#</a></h4>
<ul>
<li>Offload non-IO processing to speed up Reactor thread 通过卸载非IO操作来提升Reactor 线程的处理性能
<ul>
<li>Similar to POSA2 Proactor designs 类似与POSA2 中Proactor的设计</li>
</ul>
</li>
<li>Simpler than reworking compute-bound processing into event-driven form 比将非IO操作重新设计为事件驱动的方式更简单
<ul>
<li>Should still be pure nonblocking computation 仍然应该是纯粹的非阻塞计算
<ul>
<li>Enough processing to outweigh overhead 足够的处理超过开销</li>
</ul>
</li>
</ul>
</li>
<li>But harder to overlap processing with IO 但是很难将处理与IO重叠
<ul>
<li>Best when can first read all input into a buffer 最好能在第一时间将所有输入读入缓冲区 （这里我理解的是最好一次性读取缓冲区数据，方便异步非IO操作处理数据）</li>
</ul>
</li>
<li>Use thread pool so can tune and control 可以通过线程池的方式对线程进行调优与控制
<ul>
<li>Normally need many fewer threads than clients 通常需要比客户端少得多的线程</li>
</ul>
</li>
</ul>
<p><img loading="lazy" src="/img/source/scalable_in_java/%e5%9b%be%e7%89%87_20230817160645.png" alt="图片_20230817160645"  />
</p>
<h4 id="handler-with-thread-pool-带有线程池的处理器">Handler with Thread Pool 带有线程池的处理器<a hidden class="anchor" aria-hidden="true" href="#handler-with-thread-pool-带有线程池的处理器">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.ByteBuffer<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.channels.SelectionKey<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.channels.Selector<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.nio.channels.SocketChannel<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.concurrent.ArrayBlockingQueue<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.concurrent.ThreadPoolExecutor<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.concurrent.TimeUnit<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Handler</span> <span style="color:#66d9ef">implements</span> Runnable<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> CORE_POOL_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> MAX_POOL_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> QUEUE_CAPACITY <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Long KEEP_ALIVE_TIME <span style="color:#f92672">=</span> <span style="color:#ae81ff">1L</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// uses util.concurrent thread pool
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> ThreadPoolExecutor pool <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadPoolExecutor<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>            CORE_POOL_SIZE<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            MAX_POOL_SIZE<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            KEEP_ALIVE_TIME<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> ArrayBlockingQueue<span style="color:#f92672">&lt;&gt;(</span>QUEUE_CAPACITY<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> ThreadPoolExecutor<span style="color:#f92672">.</span><span style="color:#a6e22e">CallerRunsPolicy</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> PROCESSING <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> SocketChannel socket<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> SelectionKey sk<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    ByteBuffer input <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    ByteBuffer output <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> READING <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> SENDING <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> state <span style="color:#f92672">=</span> READING<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Handler<span style="color:#f92672">(</span>Selector sel<span style="color:#f92672">,</span> SocketChannel c<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        socket <span style="color:#f92672">=</span> c<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        c<span style="color:#f92672">.</span><span style="color:#a6e22e">configureBlocking</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Optionally try first read now
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        sk <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span><span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>sel<span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        sk<span style="color:#f92672">.</span><span style="color:#a6e22e">attach</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span> <span style="color:#75715e">//将Handler绑定到SelectionKey上
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        sk<span style="color:#f92672">.</span><span style="color:#a6e22e">interestOps</span><span style="color:#f92672">(</span>SelectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">OP_READ</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        sel<span style="color:#f92672">.</span><span style="color:#a6e22e">wakeup</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">inputIsComplete</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">/* ... */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">outputIsComplete</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">/* ... */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">process</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">/* ... */</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 这是Handler处理类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>state <span style="color:#f92672">==</span> READING<span style="color:#f92672">)</span> read<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>state <span style="color:#f92672">==</span> SENDING<span style="color:#f92672">)</span> send<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">read</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        socket<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>input<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>inputIsComplete<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//            process();
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//            state = SENDING;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//            // Normally also do first write now
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//            sk.interestOps(SelectionKey.OP_WRITE);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>            state <span style="color:#f92672">=</span> PROCESSING<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            pool<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Processer<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">send</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        socket<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>output<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>outputIsComplete<span style="color:#f92672">())</span> sk<span style="color:#f92672">.</span><span style="color:#a6e22e">cancel</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processAndHandOff</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        process<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        state <span style="color:#f92672">=</span> SENDING<span style="color:#f92672">;</span> <span style="color:#75715e">// or rebind attachment
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        sk<span style="color:#f92672">.</span><span style="color:#a6e22e">interestOps</span><span style="color:#f92672">(</span>SelectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">OP_WRITE</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Processer</span> <span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> processAndHandOff<span style="color:#f92672">();</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="coordinating-tasks-协调任务">Coordinating Tasks 协调任务<a hidden class="anchor" aria-hidden="true" href="#coordinating-tasks-协调任务">#</a></h4>
<p>当你把非IO操作放到线程池中运行时，你需要注意以下几点问题</p>
<ul>
<li>Handoffs 交接
<ul>
<li>Each task enables, triggers, or calls next one Usually fastest but can be brittle 任务之间的协调与控制，每个任务的启动、执行、传递的速度是很快的，不容易协调与控制</li>
</ul>
</li>
<li><code>Callbacks</code> to per-handler dispatcher 每个hander中dispatch的回调与状态控制
<ul>
<li>Sets state, attachment, etc A variant of GoF Mediator pattern 设置状态、附件等。GoF中介模式的一种变体</li>
</ul>
</li>
<li><code>Queues</code> 不同线程之间缓冲区的线程安全问题
<ul>
<li>For example, passing buffers across stages 例如，跨阶段传递缓冲区</li>
</ul>
</li>
<li><code>Futures</code>
<ul>
<li>When each task produces a result Coordination layered on top of join or wait/notify 需要任务返回结果时，任务线程等待和唤醒状态间的切换</li>
</ul>
</li>
</ul>
<h4 id="using-pooledexecutor-可以使用pooledexecutor线程池框架解决上面的问题">Using PooledExecutor 可以使用PooledExecutor线程池框架解决上面的问题<a hidden class="anchor" aria-hidden="true" href="#using-pooledexecutor-可以使用pooledexecutor线程池框架解决上面的问题">#</a></h4>
<ul>
<li>A tunable worker thread pool 这是一个可控的任务线程池</li>
<li>Main method execute(Runnable r) 主函数采用execute(Runnable r)</li>
<li>Controls for: 它具备以下功能，可以很好的对池中的线程与任务进行控制与管理
<ul>
<li>The kind of task queue (any Channel) 任务队列的类型(任何通道)</li>
<li>Maximum number of threads 最大线程数</li>
<li>Minimum number of threads 最小线程数</li>
<li>&ldquo;Warm&rdquo; versus on-demand threads &ldquo;预热&quot;以应对随机应变的线程 按需要判断线程的活动状态，及时处理空闲线程</li>
<li>Keep-alive interval until idle threads die 保持活动间隔，直到空闲线程死亡
<ul>
<li>to be later replaced by new ones if necessary 如有必要，以后再用新的代替</li>
</ul>
</li>
<li>Saturation policy  饱和策略 当执行任务数量超过线程池中线程数量时，有一系列的阻塞、限流的策略
<ul>
<li>block, drop, producer-runs, etc 阻塞,抛弃,producer-runs等</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="multiple-reactor-threads-基于多个反应器的多线程模式">Multiple Reactor Threads 基于多个反应器的多线程模式<a hidden class="anchor" aria-hidden="true" href="#multiple-reactor-threads-基于多个反应器的多线程模式">#</a></h4>
<ul>
<li>Using Reactor Pools 使用反应器线程池
<ul>
<li>Use to match CPU and IO rates 一方面根据实际情况用于匹配调节CPU处理与IO读写的效率，提高系统资源的利用率</li>
<li>Static or dynamic construction 另一方面在静态或动态构造中
<ul>
<li>Each with own Selector, Thread, dispatch loop 每个反应器线程都包含对应的Selector,Thread,dispatchloop</li>
</ul>
</li>
<li>Main acceptor distributes to other reactors 下面是一个简单的代码示例与示意图（Netty就是基于这个模式设计的，一个处理Accpet连接的mainReactor线程，多个处理IO事件的subReactor线程）</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Selector<span style="color:#f92672">[]</span> selectors<span style="color:#f92672">;</span> <span style="color:#75715e">// Selector集合，每一个Selector 对应一个subReactor线程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//mainReactor线程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Acceptor</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Socket connection <span style="color:#f92672">=</span> serverSocket<span style="color:#f92672">.</span><span style="color:#a6e22e">accept</span><span style="color:#f92672">();</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>connection <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">new</span> Handler<span style="color:#f92672">(</span>selectors<span style="color:#f92672">[</span>next<span style="color:#f92672">],</span> connection<span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(++</span>next <span style="color:#f92672">==</span> selectors<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            next <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><img loading="lazy" src="/img/source/scalable_in_java/%e5%9b%be%e7%89%87_20230818095843.png" alt="图片_20230818095843"  />
</p>
<h4 id="using-other-javanio-features-在服务的设计当中我们还需要注意与javanio包特性的结合">Using other java.nio features 在服务的设计当中，我们还需要注意与java.nio包特性的结合<a hidden class="anchor" aria-hidden="true" href="#using-other-javanio-features-在服务的设计当中我们还需要注意与javanio包特性的结合">#</a></h4>
<ul>
<li>Multiple Selectors per Reactor 每个反应器有多个选择器
<ul>
<li>To bind different handlers to different IO events
May need careful synchronization to coordinate 要将不同的处理程序绑定到不同的IO事件可能需要细致的同步协调编码</li>
</ul>
</li>
<li>File transfer 文件传输
<ul>
<li>Automated file-to-net or net-to-file copying 自动文件到网络或网络到文件复制</li>
</ul>
</li>
<li>Memory-mapped files 内存映射文件的方式
<ul>
<li>Access files via buffers 通过缓存区访问文件</li>
</ul>
</li>
<li>Direct buffers 直接缓冲区的方式
<ul>
<li>Can sometimes achieve zero-copy transfer
But have setup and finalization overhead
Best for applications with long-lived connections 在合适的情况下可以使用零拷贝传输，但同时这会带来初始化与内存释放的问题（需要池化与主动释放）</li>
</ul>
</li>
</ul>
<h4 id="connection-based-extensions-基于连接的扩展">Connection-Based Extensions 基于连接的扩展<a hidden class="anchor" aria-hidden="true" href="#connection-based-extensions-基于连接的扩展">#</a></h4>
<ul>
<li>Instead of a single service request 并不是单个服务请求
<ul>
<li>Client connects 客户端连接</li>
<li>Client sends a series of messages/requests 客户端发送一系列的消息/请求</li>
<li>Client disconnects 客户端断开连接</li>
</ul>
</li>
<li>Examples 样例
<ul>
<li>Databases and Transaction monitors 数据库和事务监视器</li>
<li>Multi-participant games, chat, etc 多人游戏、聊天等</li>
</ul>
</li>
<li>Can extend basic network service patterns 可以扩展基本的网络服务模式
<ul>
<li>Handle many relatively long-lived clients 处理许多寿命相对较长的客户机</li>
<li>Track client and session state (including drops) 跟踪客户端和会话状态(包括丢弃)</li>
<li>Distribute services across multiple hosts 跨多个主机分发服务</li>
</ul>
</li>
</ul>
<h2 id="api-walkthrough">API Walkthrough<a hidden class="anchor" aria-hidden="true" href="#api-walkthrough">#</a></h2>
<ul>
<li>Buffer</li>
<li>ByteBuffer
<ul>
<li>(CharBuffer, LongBuffer, etc not shown.)</li>
</ul>
</li>
<li>Channel</li>
<li>SelectableChannel</li>
<li>SocketChannel</li>
<li>ServerSocketChannel</li>
<li>FileChannel</li>
<li>Selector</li>
<li>SelectionKey</li>
</ul>
<p>Buffer</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Buffer</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">capacity</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">position</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  Buffer <span style="color:#a6e22e">position</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> newPosition<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">limit</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  Buffer <span style="color:#a6e22e">limit</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> newLimit<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  Buffer <span style="color:#a6e22e">mark</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  Buffer <span style="color:#a6e22e">reset</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  Buffer <span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  Buffer <span style="color:#a6e22e">flip</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  Buffer <span style="color:#a6e22e">rewind</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">remaining</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">hasRemaining</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isReadOnly</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><img loading="lazy" src="/img/source/scalable_in_java/%e5%9b%be%e7%89%87_20230818103012.png" alt="图片_20230818103012"  />
</p>
<p>ByteBuffer</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ByteBuffer</span> <span style="color:#66d9ef">extends</span> Buffer <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> ByteBuffer <span style="color:#a6e22e">allocateDirect</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> capacity<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> ByteBuffer <span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> capacity<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> ByteBuffer <span style="color:#a6e22e">wrap</span><span style="color:#f92672">(</span><span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> src<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> offset<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> len<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> ByteBuffer <span style="color:#a6e22e">wrap</span><span style="color:#f92672">(</span><span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> src<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isDirect</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteOrder <span style="color:#a6e22e">order</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">order</span><span style="color:#f92672">(</span>ByteOrder bo<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">slice</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">duplicate</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">compact</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">asReadOnlyBuffer</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">byte</span> <span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">byte</span> <span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> index<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> dst<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> offset<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> length<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> dst<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#66d9ef">byte</span> b<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> index<span style="color:#f92672">,</span> <span style="color:#66d9ef">byte</span> b<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> src<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> offset<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> length<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>ByteBuffer src<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> src<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> <span style="color:#a6e22e">getChar</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> <span style="color:#a6e22e">getChar</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> index<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">putChar</span><span style="color:#f92672">(</span><span style="color:#66d9ef">char</span> value<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">putChar</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> index<span style="color:#f92672">,</span> <span style="color:#66d9ef">char</span> value<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    CharBuffer <span style="color:#a6e22e">asCharBuffer</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">short</span> <span style="color:#a6e22e">getShort</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">short</span> <span style="color:#a6e22e">getShort</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> index<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">putShort</span><span style="color:#f92672">(</span><span style="color:#66d9ef">short</span> value<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">putShort</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> index<span style="color:#f92672">,</span> <span style="color:#66d9ef">short</span> value<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ShortBuffer <span style="color:#a6e22e">asShortBuffer</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getInt</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getInt</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> index<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">putInt</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> value<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">putInt</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> index<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> value<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    IntBuffer <span style="color:#a6e22e">asIntBuffer</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">getLong</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">getLong</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> index<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">putLong</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> value<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">putLong</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> index<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> value<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    LongBuffer <span style="color:#a6e22e">asLongBuffer</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> <span style="color:#a6e22e">getFloat</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> <span style="color:#a6e22e">getFloat</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> index<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">putFloat</span><span style="color:#f92672">(</span><span style="color:#66d9ef">float</span> value<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">putFloat</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> index<span style="color:#f92672">,</span> <span style="color:#66d9ef">float</span> value<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    FloatBuffer <span style="color:#a6e22e">asFloatBuffer</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">getDouble</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">getDouble</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> index<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">putDouble</span><span style="color:#f92672">(</span><span style="color:#66d9ef">double</span> value<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ByteBuffer <span style="color:#a6e22e">putDouble</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> index<span style="color:#f92672">,</span> <span style="color:#66d9ef">double</span> value<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    DoubleBuffer <span style="color:#a6e22e">asDoubleBuffer</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Channel</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Channel</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isOpen</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">close</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">ReadableByteChannel</span> <span style="color:#66d9ef">extends</span> Channel <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>ByteBuffer dst<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">WritableByteChannel</span> <span style="color:#66d9ef">extends</span> Channel <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>ByteBuffer src<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">ScatteringByteChannel</span> <span style="color:#66d9ef">extends</span> ReadableByteChannel <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>ByteBuffer<span style="color:#f92672">[]</span> dsts<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> offset<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> length<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>ByteBuffer<span style="color:#f92672">[]</span> dsts<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">GatheringByteChannel</span> <span style="color:#66d9ef">extends</span> WritableByteChannel <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>ByteBuffer<span style="color:#f92672">[]</span> srcs<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> offset<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> length<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>ByteBuffer<span style="color:#f92672">[]</span> srcs<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>SelectableChannel</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SelectableChannel</span> <span style="color:#66d9ef">implements</span> Channel <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">validOps</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isRegistered</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> SelectionKey <span style="color:#a6e22e">keyFor</span><span style="color:#f92672">(</span>Selector sel<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> SelectionKey <span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>Selector sel<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> ops<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">throws</span> ClosedChannelException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configureBlocking</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> block<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isBlocking</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> Object <span style="color:#a6e22e">blockingLock</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>SocketChannel</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SocketChannel</span> <span style="color:#66d9ef">implements</span> ByteChannel<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">static</span> SocketChannel <span style="color:#a6e22e">open</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> Socket <span style="color:#a6e22e">socket</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">validOps</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isConnected</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isConnectionPending</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isInputOpen</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isOutputOpen</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">connect</span><span style="color:#f92672">(</span>SocketAddress remote<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">finishConnect</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">shutdownInput</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">shutdownOutput</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>ByteBuffer dst<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>ByteBuffer<span style="color:#f92672">[]</span> dsts<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> offset<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> length<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>ByteBuffer<span style="color:#f92672">[]</span> dsts<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>ByteBuffer src<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>ByteBuffer<span style="color:#f92672">[]</span> srcs<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> offset<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> length<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>ByteBuffer<span style="color:#f92672">[]</span> srcs<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>ServerSocketChannel</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ServerSocketChannel</span> <span style="color:#66d9ef">extends</span> SocketChannel <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">static</span> ServerSocketChannel <span style="color:#a6e22e">open</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">validOps</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> ServerSocket <span style="color:#a6e22e">socket</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> SocketChannel <span style="color:#a6e22e">accept</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>FileChannel</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FileChannel</span> <span style="color:#66d9ef">implements</span> <span style="color:#f92672">...</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>ByteBuffer dst<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>ByteBuffer dst<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> position<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>ByteBuffer<span style="color:#f92672">[]</span> dsts<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> offset<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> length<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>ByteBuffer<span style="color:#f92672">[]</span> dsts<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>ByteBuffer src<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>ByteBuffer src<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> position<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>ByteBuffer<span style="color:#f92672">[]</span> srcs<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> offset<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> length<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>ByteBuffer<span style="color:#f92672">[]</span> srcs<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">position</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">position</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> newPosition<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">truncate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> size<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">force</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> flushMetaDataToo<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">transferTo</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> position<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> count<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span> WritableByteChannel dst<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">transferFrom</span><span style="color:#f92672">(</span>ReadableByteChannel src<span style="color:#f92672">,</span> 
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">long</span> position<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> count<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> FileLock <span style="color:#a6e22e">lock</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> position<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> size<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> shared<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> FileLock <span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> FileLock <span style="color:#a6e22e">tryLock</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> pos<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> size<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> shared<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> FileLock <span style="color:#a6e22e">tryLock</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> MAP_RO<span style="color:#f92672">,</span> MAP_RW<span style="color:#f92672">,</span> MAP_COW<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> MappedByteBuffer <span style="color:#a6e22e">map</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> mode<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> position<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> size<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span> 
</span></span></code></pre></div><p>Selector</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Selector</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">static</span> Selector <span style="color:#a6e22e">open</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> Set <span style="color:#a6e22e">keys</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> Set <span style="color:#a6e22e">selectedKeys</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">selectNow</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">select</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> timeout<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">select</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">wakeup</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">close</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>SelectionKey</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SelectionKey</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> OP_READ<span style="color:#f92672">,</span> OP_WRITE<span style="color:#f92672">,</span> 
</span></span><span style="display:flex;"><span> OP_CONNECT<span style="color:#f92672">,</span> OP_ACCEPT<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> SelectableChannel <span style="color:#a6e22e">channel</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> Selector <span style="color:#a6e22e">selector</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isValid</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">cancel</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">interestOps</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">interestOps</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> ops<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">readyOps</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isReadable</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isWritable</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isConnectable</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isAcceptable</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> Object <span style="color:#a6e22e">attach</span><span style="color:#f92672">(</span>Object ob<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> Object <span style="color:#a6e22e">attachment</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li><a href="http://gee.cs.oswego.edu/dl/cpjslides/nio.pdf">Doug Lea - Scalable IO in Java</a></li>
<li><a href="https://www.cnblogs.com/dafanjoy/p/11217708.html">《Scalable IO in Java》译文 </a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://847850277.github.io/">ZhengPengDe Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
