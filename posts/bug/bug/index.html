<!DOCTYPE html>
<html class="nojs" lang="zh-cn" dir="ltr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>bug 记录 – ZhengPengDe Blog</title>
<meta name="description" content="bug 记录">
<meta name="created" content="2015-07-01T09:00:00+0000">
<meta name="modified" content="2023-06-01T09:00:00+0000">
<meta name="author" content="zhengpengde">

<meta property="og:site_name" content="ZhengPengDe Blog">
<meta property="og:title" content="bug 记录">
<meta property="og:url" content="https://847850277.github.io/posts/bug/bug/">
<meta property="og:type" content="article">

<meta name="generator" content="Hugo 0.112.5">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="theme-color" content="#ffffff">


<link rel="canonical" href="https://847850277.github.io/posts/bug/bug/">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">

<link rel="stylesheet" href="/css/styles.f5f42549a2ff6655f6895613fdad4142b37562f0565fa9def394a039f13e54fa.css">
<link rel="stylesheet" href="/css/print.31e2819287afc91406f2fd43d21a8ba4a0cdfc272e439c90db0c6e47efc7c346.css" media="print">

<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "WebPage",
    "headline": "bug 记录",
    "datePublished": "2015-07-01T09:00:00Z",
    "dateModified": "2023-06-01T09:00:00Z",
    "url" : "https://847850277.github.io/posts/bug/bug/",
    "description": "bug 记录",
    "keywords": ["bug"],
    "author": {
      "@type": "Person",
      "name": "zhengpengde"
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https://847850277.github.io/"
    },
    "publisher": {
      "@type": "Organization",
      "name": "ZhengPengDe Blog",
      "url": "https://847850277.github.io/"
    }
  }
</script>

<script src="/js/script-early.min.21220209af63c496c7531316922ef9a4548661be9388bbcd1f9899bb0b842b21.js"></script>

<script defer src="/js/script.min.f8f04035e9a9424ebc267c1a5fdb513d79b611a04b85cab2ac414d091ac9e94c.js"></script>



</head>

<body class="single-page">
<div class="page layout__page">
<header class="header layout__header mb--m">
<a href="/" title="Home" rel="home" class="header__logo">
<img src="/images/logo.png" alt="Home" class="header__logo-image">
</a>
<h1 class="header__site-name">
<a href="/" title="Home" class="header__site-link" rel="home"><span>ZhengPengDe Blog</span></a>
</h1>
<div class="region header__region">
</div>
</header>

<nav class="main-menu layout__navigation" aria-label="Main menu">
<ul class="navbar">
<li><a href="/">Home</a></li>
<li><a href="/posts/" aria-current="page">Posts</a></li>
</ul>
</nav>
<main class="main layout__main">
<article class="single-view single-view--posts">
<header>
<h1 class="title ">bug 记录</h1>
<div class="tags meta">
Tags:
<ul>
<li><a href="https://847850277.github.io/tags/bug/">bug</a></li>
</ul>
</div>
</header>
<div class="content">
<h1 id="bug清单表格">bug清单表格</h1>
<h2 id="a-href1springboot上传文件报流关闭错误a"><!-- raw HTML omitted -->springboot上传文件，报流关闭错误<!-- raw HTML omitted --></h2>
<h2 id="a-href2某些sql会在limit后追加一个limit导致查询sql报错a"><!-- raw HTML omitted -->某些sql会在limit后追加一个limit，导致查询sql报错<!-- raw HTML omitted --></h2>
<h2 id="a-href3请求接口返回90044错误a"><!-- raw HTML omitted -->请求接口，返回90044错误<!-- raw HTML omitted --></h2>
<h2 id="a-href4小程序获取手机号授权并未生成响应的学员记录a"><!-- raw HTML omitted -->小程序获取手机号授权，并未生成响应的学员记录<!-- raw HTML omitted --></h2>
<h2 id="a-href5crm服务导入数据特定的获客渠道异界交换才能够导入a"><!-- raw HTML omitted -->crm服务导入数据、特定的获客渠道（异界交换）才能够导入<!-- raw HTML omitted --></h2>
<h2 id="a-href6支付成功后在crm的h5页面填入分单的数据结果分单后的比例并没有按对应比例保存a"><!-- raw HTML omitted -->支付成功后，在crm的h5页面填入分单的数据、结果分单后的比例并没有按对应比例保存<!-- raw HTML omitted --></h2>
<h2 id="a-href7有一个定时然后推送消息的功能同时推送短信和微信模版消息a"><!-- raw HTML omitted -->有一个定时然后推送消息的功能，同时推送短信和微信模版消息。<!-- raw HTML omitted --></h2>
<h2 id="a-href8订单支付成功生成了3条相同的费用明细同时生成了三个正式学员有预警邮件提醒a"><!-- raw HTML omitted -->订单支付成功，生成了3条相同的费用明细，同时生成了三个正式学员，有预警邮件提醒<!-- raw HTML omitted --></h2>
<h2 id="a-href9在正式学员列表里面搜索姓名姓名无法找到该学员但是搜索学员昵称或者电话号码又可以找到该学员a"><!-- raw HTML omitted -->在正式学员列表里面，搜索姓名姓名无法找到该学员，但是搜索学员昵称或者电话号码又可以找到该学员&hellip;<!-- raw HTML omitted --></h2>
<h2 id="a-href10通过转介绍渠道来的新的意向客户数据其跟进人的扫码归属人字段未写入值a"><!-- raw HTML omitted -->通过转介绍渠道来的新的意向客户数据，其跟进人的扫码归属人字段未写入值<!-- raw HTML omitted --></h2>
<h2 id="a-href11omo转介绍小程序提交了预约相关信息其生成了活动记录但是并未生成客户记录a"><!-- raw HTML omitted -->omo转介绍小程序，提交了预约相关信息，其生成了活动记录，但是并未生成客户记录<!-- raw HTML omitted --></h2>
<h2 id="a-href12数据字典的校区由新校变成老校定时未生效a"><!-- raw HTML omitted -->数据字典的校区由新校变成老校定时未生效<!-- raw HTML omitted --></h2>
<h2 id="a-href13启动项目提示拿不到数据库的链接a"><!-- raw HTML omitted -->启动项目提示拿不到数据库的链接<!-- raw HTML omitted --></h2>
<h2 id="a-href14暑期三节课发起支付后订单支付状态未变更为支付中a"><!-- raw HTML omitted -->暑期三节课发起支付后，订单支付状态未变更为支付中<!-- raw HTML omitted --></h2>
<h2 id="a-href151客户详细存在跟进人为空的数据2sql查询的逻辑为即查询跟进人的id又查询冗余跟进人名称同时冗余跟进人名称会存在为空的数据a"><!-- raw HTML omitted -->1.客户详细存在跟进人为空的数据2.sql查询的逻辑为即查询跟进人的id，又查询冗余跟进人名称，同时冗余跟进人名称会存在为空的数据<!-- raw HTML omitted --></h2>
<h2 id="a-href16导出正式学员列表增加扫码归属人和收单人员两列字段a"><!-- raw HTML omitted -->导出正式学员列表增加扫码归属人和收单人员两列字段<!-- raw HTML omitted --></h2>
<h2 id="a-href17优惠券退款点击驳回或者废除若原状态为已经回收其状态还是变更成未使用并没有退回为原本状态a"><!-- raw HTML omitted -->优惠券退款，点击驳回或者废除。若原状态为已经回收，其状态还是变更成未使用，并没有退回为原本状态<!-- raw HTML omitted --></h2>
<h2 id="a-href18线上支付在使用支付宝付款时候提示操作失败网络或者服务器错误a"><!-- raw HTML omitted -->线上支付在使用支付宝付款时候提示“操作失败：网络或者服务器错误”<!-- raw HTML omitted --></h2>
<h2 id="a-href19定时同步标签但是其值并未写入数据库a"><!-- raw HTML omitted -->定时同步标签，但是其值并未写入数据库<!-- raw HTML omitted --></h2>
<h2 id="a-href20selenium模拟微信登陆选择封面图失败报js的异常a"><!-- raw HTML omitted -->selenium模拟微信登陆选择封面图失败，报js的异常<!-- raw HTML omitted --></h2>
<h2 id="a-href21活动小程序部分用户唤起支付控件失败a"><!-- raw HTML omitted -->活动小程序部分用户唤起支付控件失败<!-- raw HTML omitted --></h2>
<h2 id="a-href22模拟代码用队列发送前置消息失败但是走支付流程真实付款前置流程成功且调用发送mq的方法为同一个并无差异a"><!-- raw HTML omitted -->模拟代码用队列发送前置消息失败，但是走支付流程真实付款，前置流程成功。且调用发送MQ的方法为同一个，并无差异<!-- raw HTML omitted --></h2>
<h2 id="a-href23模拟支付集成测试用例的数据驱动的开发a"><!-- raw HTML omitted -->模拟支付集成测试用例的数据驱动的开发<!-- raw HTML omitted --></h2>
<h2 id="a-href24hexo-下的分类和表签无法显示怎么解决a"><!-- raw HTML omitted -->hexo 下的分类和表签无法显示，怎么解决？<!-- raw HTML omitted --></h2>
<h2 id="a-href25增加transactional定时调度生成了多条记录a"><!-- raw HTML omitted -->增加@transactional，定时调度生成了多条记录<!-- raw HTML omitted --></h2>
<h2 id="a-href26优惠券状态后置导致执行更新优惠券状态失败影响整个订单后置流程a"><!-- raw HTML omitted -->优惠券状态后置，导致执行更新优惠券状态失败，影响整个订单后置流程<!-- raw HTML omitted --></h2>
<h2 id="a-href27请求接口返回90044错误a"><!-- raw HTML omitted -->请求接口，返回90044错误<!-- raw HTML omitted --></h2>
<h2 id="a-href28datagrip导出文件自动加双引号a"><!-- raw HTML omitted -->datagrip导出文件自动加双引号<!-- raw HTML omitted --></h2>
<h2 id="a-href29排查order服务中一分钟gc次数大于30次a"><!-- raw HTML omitted -->排查order服务中一分钟GC次数大于30次<!-- raw HTML omitted --></h2>
<h2 id="a-href30支付高并发场景下数据库间隙锁导致的数据库死锁a"><!-- raw HTML omitted -->支付高并发场景下数据库间隙锁导致的数据库死锁<!-- raw HTML omitted --></h2>
<h2 id="a-href31mockito-given-willreturn-没有正确返回a"><!-- raw HTML omitted -->Mockito given willReturn 没有正确返回<!-- raw HTML omitted --></h2>
<!-- raw HTML omitted -->
<pre><code>    },
    &quot;mappings&quot;:{
        &quot;_doc&quot;:{
            &quot;properties&quot;:{
                &quot;id&quot;:{
                    &quot;type&quot;:&quot;text&quot;,
                    &quot;fields&quot;:{
                        &quot;keyword&quot;:{
                            &quot;type&quot;:&quot;keyword&quot;,
                            &quot;ignore_above&quot;:256
                        }
                    }
                },
                &quot;request_time&quot;:{
                    &quot;type&quot;:&quot;text&quot;,
                    &quot;fields&quot;:{
                        &quot;keyword&quot;:{
                            &quot;type&quot;:&quot;keyword&quot;,
                            &quot;ignore_above&quot;:256
                        }
                    }
                }
            }
        }
    },
    &quot;settings&quot;:{
        &quot;index&quot;:{
            &quot;creation_date&quot;:&quot;1637288113508&quot;,
            &quot;number_of_shards&quot;:&quot;5&quot;,
            &quot;number_of_replicas&quot;:&quot;1&quot;,
            &quot;uuid&quot;:&quot;x-dn1nyfTlShjKD8n-HUGQ&quot;,
            &quot;version&quot;:{
                &quot;created&quot;:&quot;6080099&quot;
            },
            &quot;provided_name&quot;:&quot;index_pay_center_request_dev&quot;
        }
    }
}
</code></pre>
<p>}
<code>4、扩展增加long类型的请求时间和long类型的响应时间     &lt;/th&gt; &lt;th&gt; &lt;/th&gt; &lt;th&gt; &lt;/th&gt; &lt;/tr&gt; &lt;tr&gt; &lt;th&gt;&lt;a name=&quot;27&quot;&gt;27&lt;/a&gt;&lt;/th&gt; &lt;th&gt;2021-12-01&lt;/th&gt; &lt;th&gt; 优惠券过期导致支付成功的后置流程失败 &lt;/th&gt; &lt;th&gt; 然后创建订单的时候，优惠券状态为使用中，执行定时任务导致使用中变成过期。从而导致整个订单后置流程失败。 &lt;/th&gt; &lt;th&gt; 1.利用接口把优惠券的状态前置， 2.再手动触发后置流程状态 &lt;/th&gt; &lt;th&gt; 1、监控邮件提醒支付后置优惠券状态不对&lt;br/&gt; 2、排查过期定时任务导致使用中的优惠券状态为过期</code> sql
&ndash; 查询未生成的费用明细
select
t_order.SERIAL,
t_cost_detail.SERIAL
from dyjw_aggregate_layer.t_order
left join dyjw_aggregate_layer.t_cost_detail on t_order.SERIAL = t_cost_detail.SERIAL
where  t_order.CREATEDATE &gt;= &lsquo;2021-10-01&rsquo; and t_order.STATUS = 2 and t_order.GOODTYPE != &lsquo;优惠券&rsquo;
and t_cost_detail.SERIAL is null
;
<code>1. 用接口调整用户领用优惠券的状态，同时触发后置流程&lt;br/&gt; &lt;/th&gt; &lt;th&gt; &lt;/th&gt; &lt;th&gt; &lt;/th&gt; &lt;/tr&gt; &lt;tr&gt; &lt;th&gt;&lt;a name=&quot;28&quot;&gt;28&lt;/a&gt;&lt;/th&gt; &lt;th&gt;2022-01-07&lt;/th&gt; &lt;th&gt; datagrip导出查询结果自动加双引号 &lt;/th&gt; &lt;th&gt; 1、idea配置问题，默认导出配置加上了引号 2、在database的csv formarts格式话选项中 &lt;/th&gt; &lt;th&gt; 见下图配置，可解决该问题 &lt;img src='http://117.50.163.170:9000/resource/WechatIMG1214.png'&gt; &lt;/th&gt; &lt;th&gt; &lt;/th&gt; &lt;th&gt; &lt;/th&gt; &lt;th&gt; &lt;/th&gt; &lt;/tr&gt; &lt;tr&gt; &lt;th&gt;&lt;a name=&quot;29&quot;&gt;29&lt;/a&gt;&lt;/th&gt; &lt;th&gt;2022-03-31&lt;/th&gt; &lt;th&gt; 服务监控群中，在03-30日下午5点的时候，报警出现一小时内GC次数超过30次 &lt;img src='http://117.50.163.170:9000/blog/WechatIMG1304.png'&gt; &lt;/th&gt; &lt;th&gt; 1、排查http-log的日志，未发现频繁请求，在4点50到5点10分之间，服务的接口请求命中条数为100多条 2、继续查看http-log的日志，发现有两个接口请求的返回json字段值超级长，而且接口的耗时为6S。 3、排查代码，发现有一个sql查询会查询数据库的记录条数超过2万条 &lt;/th&gt; &lt;th&gt; 1、调整查询的逻辑，没有必要去查询快照信息的几万条记录 2、快照逻辑也不太合理 &lt;/th&gt; &lt;th&gt; &lt;/th&gt; &lt;th&gt; 1、大对象使用导致频繁的GC 2、代码中字符串的拼接使用的是String，而没有使用字符串对象去拼接，会导致创建很多的字符串对象 &lt;/th&gt; &lt;th&gt; &lt;/th&gt; &lt;/tr&gt; &lt;tr&gt; &lt;th&gt;&lt;a name=&quot;30&quot;&gt;30&lt;/a&gt;&lt;/th&gt; &lt;th&gt;2022-06-20&lt;/th&gt; &lt;th&gt; 6月18日做续报活动是，在支付服务请求量大的情况下，发生了数据库死锁的现象 &lt;/th&gt; &lt;th&gt; 1、让运维把死锁当时的数据库状态日志给导出来了 2、具体的内容见该附件&lt;a href=&quot;http://117.50.163.170:9000/blog/5050CDFF-6CC7-460a-86F3-B6530FB53D3D.txt&quot; target=&quot;blank&quot;&gt;点击下载附件&lt;/a&gt; &lt;/th&gt; &lt;th&gt; 1、高并发下，更新条件为索引字段，且又插入数据。由于数据库的间隙锁导致数据库死锁 &lt;/th&gt; &lt;th&gt; 1、修改更新条件为数据库主键更新 &lt;/th&gt; &lt;th&gt; &lt;/th&gt; &lt;th&gt; &lt;a href=&quot;https://www.cnblogs.com/wanglifeng717/archive/2022/03/11/15993400.html&quot; target=&quot;blank&quot;&gt;参考解决文章&lt;/a&gt; &lt;/th&gt; &lt;/tr&gt; &lt;tr&gt; &lt;th&gt;&lt;a name=&quot;31&quot;&gt;31&lt;/a&gt;&lt;/th&gt; &lt;th&gt;2022-11-01&lt;/th&gt; &lt;th&gt; 使用Mockito given and willReturn的时候，设置了willReturn的值,但是在mockMvc的调用情况下返回为空 &lt;/th&gt; &lt;th&gt; 1、参数对象并未覆盖hashCode方法,导致每次调用方法的hashCode值不一致，也就是导致Mockito没有代理成功 &lt;/th&gt; &lt;th&gt; 1、针对参数类型的对象，覆盖一下hashCode方法 &lt;/th&gt; &lt;th&gt; 1、代码如下，ApiQuery对象覆盖一下hashCode方法就可以解决</code>java
//调用方法
final ApiQuery apiQuery = new ApiQuery(&ldquo;string&rdquo;, 0, &ldquo;&rdquo;, pageParameter);
given(this.apiService.listByPage(apiQuery)).willReturn(commonPager);
this.mockMvc.perform(MockMvcRequestBuilders.get(&quot;/api&quot;)
.param(&ldquo;apiPath&rdquo;, &ldquo;string&rdquo;)
.param(&ldquo;state&rdquo;, &ldquo;0&rdquo;)
.param(&ldquo;tagId&rdquo;, &ldquo;&rdquo;)
.param(&ldquo;currentPage&rdquo;, pageParameter.getCurrentPage() + &ldquo;&rdquo;)
.param(&ldquo;pageSize&rdquo;, pageParameter.getPageSize() + &ldquo;&rdquo;))
.andExpect(status().isOk())
.andExpect(jsonPath(&quot;$.message&quot;, is(ShenyuResultMessage.QUERY_SUCCESS)))
.andExpect(jsonPath(&quot;$.data.dataList[0].contextPath&quot;, is(apiVO.getContextPath())))
.andReturn();
//重写hashCode
public boolean equals(final Object o) {
if (this == o) {
return true;
}
if (!(o instanceof ApiQuery)) {
return false;
}
ApiQuery apiQuery = (ApiQuery) o;
return apiPath.equals(apiQuery.apiPath) &amp;&amp; state.equals(apiQuery.state) &amp;&amp; tagId.equals(apiQuery.tagId) &amp;&amp; pageParameter.equals(apiQuery.pageParameter);
}
```
2、Mockito底层用的ByteBuddy去做代理，动态生成字节码，通过判断参数的值，也就是参数对应的hashCode是不是匹配的值，如果是就走代理方法，不是就走原来的方法，来实现参数的returnValue拦截
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->

</div>

<div class="content content--bottom">
<div class="content-dates meta">
Updated: 1 June, 2023<br>
Created: 1 July, 2015
</div>
</div>
</article>
</main>


<footer class="footer layout__footer mt--l">
<p><span>© ZhengPengDe Blog</span></p>


</footer>

</div>
</body>
</html>
